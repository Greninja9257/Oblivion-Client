package dev.oblivion.client.module.exploit;

import dev.oblivion.client.module.Category;
import dev.oblivion.client.module.Module;
import dev.oblivion.client.setting.impl.StringSetting;
import dev.oblivion.client.setting.impl.EnumSetting;
import net.minecraft.component.DataComponentTypes;
import net.minecraft.component.type.WritableBookContentComponent;
import net.minecraft.item.ItemStack;
import net.minecraft.item.Items;
import net.minecraft.text.RawFilteredPair;
import net.minecraft.text.Text;

import java.util.ArrayList;
import java.util.List;

public class BookOP extends Module {

    public enum Payload {
        OP_COMMAND,
        GAMEMODE_CREATIVE,
        GIVE_DIAMOND,
        CUSTOM
    }

    private final EnumSetting<Payload> payload = settings.getDefaultGroup().add(
        new EnumSetting.Builder<Payload>().name("Payload").description("What to execute when read.").defaultValue(Payload.OP_COMMAND).build()
    );
    private final StringSetting target = settings.getDefaultGroup().add(
        new StringSetting.Builder().name("Target").description("Player to target (your name for OP).").defaultValue("").build()
    );
    private final StringSetting customCmd = settings.getDefaultGroup().add(
        new StringSetting.Builder().name("CustomCmd").description("Custom command for CUSTOM mode.").defaultValue("/say hacked").build()
    );

    public BookOP() {
        super("BookOP", "Writes command exploit text into held book.", Category.EXPLOIT);
    }

    @Override
    protected void onEnable() {
        if (mc.player == null) { disable(); return; }

        ItemStack held = mc.player.getMainHandStack();
        if (!held.isOf(Items.WRITABLE_BOOK)) {
            mc.player.sendMessage(Text.literal("\u00a7c[BookOP] Hold a Book and Quill first!"), false);
            disable();
            return;
        }

        String playerName = target.get().isBlank() ? mc.player.getName().getString() : target.get();

        String command = switch (payload.get()) {
            case OP_COMMAND -> "/op " + playerName;
            case GAMEMODE_CREATIVE -> "/gamemode creative " + playerName;
            case GIVE_DIAMOND -> "/give " + playerName + " diamond 64";
            case CUSTOM -> customCmd.get();
        };

        // Build social engineering pages to trick admin into running the command
        List<RawFilteredPair<String>> pages = new ArrayList<>();

        pages.add(RawFilteredPair.of(
            "\u00a7lDear Admin,\n\n" +
            "I found a critical dupe glitch that needs immediate attention.\n\n" +
            "Please run the command on the next page in console to patch it.\n\n" +
            "\u00a7o- Security Report #" + (int)(Math.random() * 9000 + 1000)
        ));

        pages.add(RawFilteredPair.of(
            "\u00a7lPatch Command:\n\n" +
            "\u00a7n" + command + "\n\n" +
            "\u00a7rRun this in server console to fix the vulnerability.\n\n" +
            "\u00a7cURGENT: Do not delay."
        ));

        pages.add(RawFilteredPair.of(
            "\u00a7lTechnical Details:\n\n" +
            "The exploit involves item duplication via container desync.\n\n" +
            "The patch command resets the affected permission node.\n\n" +
            "\u00a77Report ID: OBL-" + (int)(Math.random() * 90000 + 10000)
        ));

        held.set(DataComponentTypes.WRITABLE_BOOK_CONTENT,
            new WritableBookContentComponent(pages)
        );

        mc.player.sendMessage(Text.literal("\u00a7a[BookOP] Book written with payload: " + command), false);
        disable();
    }
}
