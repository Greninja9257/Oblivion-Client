package dev.oblivion.client.module.exploit;

import dev.oblivion.client.event.EventHandler;
import dev.oblivion.client.event.events.PacketEvent;
import dev.oblivion.client.module.Category;
import dev.oblivion.client.module.Module;
import dev.oblivion.client.setting.impl.IntSetting;
import dev.oblivion.client.setting.impl.BoolSetting;
import dev.oblivion.client.util.ChatUtil;
import net.minecraft.component.DataComponentTypes;
import net.minecraft.component.type.WrittenBookContentComponent;
import net.minecraft.component.type.NbtComponent;
import net.minecraft.item.ItemStack;
import net.minecraft.item.Items;
import net.minecraft.network.packet.s2c.play.ScreenHandlerSlotUpdateS2CPacket;
import net.minecraft.network.packet.s2c.play.InventoryS2CPacket;

import java.util.List;

public class AntiCrashItem extends Module {

    private final IntSetting maxBookPages = settings.getDefaultGroup().add(
        new IntSetting.Builder()
            .name("Max Book Pages")
            .description("Maximum allowed book pages before stripping.")
            .defaultValue(20)
            .range(1, 100)
            .build()
    );

    private final BoolSetting stripOversizedBooks = settings.getDefaultGroup().add(
        new BoolSetting.Builder()
            .name("Strip Oversized Books")
            .description("Remove data from books with too many pages or huge text.")
            .defaultValue(true)
            .build()
    );

    private final BoolSetting stripCustomData = settings.getDefaultGroup().add(
        new BoolSetting.Builder()
            .name("Strip Custom Data")
            .description("Remove custom data components that could cause crashes.")
            .defaultValue(true)
            .build()
    );

    private final BoolSetting notify = settings.getDefaultGroup().add(
        new BoolSetting.Builder()
            .name("Notify")
            .description("Show a chat message when a crash item is neutralized.")
            .defaultValue(true)
            .build()
    );

    public AntiCrashItem() {
        super("AntiCrashItem", "Prevents crash items from crashing your client, allowing safe handling.", Category.EXPLOIT);
    }

    @EventHandler
    public void onPacketReceive(PacketEvent.Receive event) {
        if (mc.player == null) return;

        if (event.getPacket() instanceof ScreenHandlerSlotUpdateS2CPacket packet) {
            ItemStack stack = packet.getStack();
            if (sanitize(stack)) {
                if (notify.get()) ChatUtil.warning("Neutralized a crash item in slot " + packet.getSlot());
            }
        }

        if (event.getPacket() instanceof InventoryS2CPacket packet) {
            List<ItemStack> stacks = packet.getContents();
            for (int i = 0; i < stacks.size(); i++) {
                if (sanitize(stacks.get(i))) {
                    if (notify.get()) ChatUtil.warning("Neutralized a crash item in inventory sync.");
                }
            }
        }
    }

    private boolean sanitize(ItemStack stack) {
        if (stack == null || stack.isEmpty()) return false;
        boolean modified = false;

        // Strip oversized written books
        if (stripOversizedBooks.get()) {
            WrittenBookContentComponent book = stack.get(DataComponentTypes.WRITTEN_BOOK_CONTENT);
            if (book != null) {
                if (book.pages().size() > maxBookPages.get()) {
                    stack.remove(DataComponentTypes.WRITTEN_BOOK_CONTENT);
                    modified = true;
                } else {
                    // Check for oversized page content
                    for (var page : book.pages()) {
                        String text = page.raw().getString();
                        if (text.length() > 5000) {
                            stack.remove(DataComponentTypes.WRITTEN_BOOK_CONTENT);
                            modified = true;
                            break;
                        }
                    }
                }
            }
        }

        // Strip custom data that could cause rendering crashes
        if (stripCustomData.get()) {
            NbtComponent customData = stack.get(DataComponentTypes.CUSTOM_DATA);
            if (customData != null) {
                String nbtString = customData.copyNbt().toString();
                if (nbtString.length() > 50000) {
                    stack.remove(DataComponentTypes.CUSTOM_DATA);
                    modified = true;
                }
            }
        }

        return modified;
    }
}
